# This is a basic workflow that is manually triggered

on:
  push:
    # Sequence of patterns matched against refs/tags
    tags:
      - 'v*' # Push events to matching v*, i.e. v1.0, v20.15.10

name: update debian changelog

jobs:
  build:
    name: update changelog
    runs-on: ubuntu-latest
    steps:
    - name: Checkout master      
      uses: actions/checkout@master
      with:
          ref: master
          fetch-depth: 0
    - name: Run info        
      run: |
            CURR_DIR=$(pwd)
            revision="HEAD"
            buildName="Auto-build"
            FullCommit=$(git -C $CURR_DIR rev-parse $revision)
            if [ -z ${FullCommit+x} ]; then
                echo "Failed on get commit for $revision revision [$FullCommit]";
                exit 1;
            fi
            echo "* FullCommit [$FullCommit]"
            LastTag=$(git -C $CURR_DIR describe --tags --first-parent --match "*" $revision)
            echo "* TAG [$LastTag]"
            if [ -z ${LastTag+x} ]; then
              LastTag="0.0.0.$buildnum"
              echo "Failed on get tag for revision $revision - defaulting to $LastTag"
            fi
            parsestr="$(echo -e "${LastTag}" | sed -e 's/^[a-zA-Z]*//')"
            Major=`echo "${parsestr}" | awk -F"[./-]" '{print $1}'`
            Minor=`echo "${parsestr}" | awk -F"[./-]" '{print $2}'`
            buildName=`echo "${parsestr}" | awk -F"[./-]" '{print $3}'`
            echo -e "* [$LastTag] => [$Major.$Minor.$Patch.$buildnum]"
            echo -e "* Release Name [$buildName]"
            gitTagList=$(git -C $CURR_DIR tag --sort=-version:refname)
            gitTagListCount=$(echo -n "$gitTagList" | grep -c '^')
            if [[ 1 -ge "$gitTagListCount" ]]; then
                echo "Use all entries for a release note:"
                releaseNote=$(git -C $CURR_DIR log --date=short --pretty=format:"  * %s [%aN] %ad")
            else
                tmpval=$(echo "${gitTagList}" | awk 'NR==2{print}')
                gitTagRange="${tmpval}..${revision}"
                echo "Release note range [$gitTagRange]"
                releaseNote=$(git -C $CURR_DIR log "$gitTagRange" --date=short --pretty=format:"  * %s [%aN] %ad")
            fi
            echo ""
            echo "***** Prepare distr changelog";
            echo ""
            echo "logview (${Major}.${Minor}.${buildnum}) unstable; urgency=medium"         > "${CURR_DIR}/debian/changelog"
            echo ""                                                                        >> "${CURR_DIR}/debian/changelog"
            echo "$releaseNote"                                                            >> "${CURR_DIR}/debian/changelog"
            echo ""                                                                        >> "${CURR_DIR}/debian/changelog"
            echo " -- chipmunk.sm <dannico@linuxmail.org>  $(LANG=C date -R)"              >> "${CURR_DIR}/debian/changelog"
            cat "${CURR_DIR}/debian/changelog"
      

